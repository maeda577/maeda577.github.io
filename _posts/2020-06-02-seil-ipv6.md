---
title: ひかり電話無し環境でSEIL/X1のIPv6 IPoEとtransix
categories:
- Blog
date: 2020-06-02 19:55 +0900
---
うっかりSEIL/X1を買ったので設定しました。

前提条件
-------------------------------
* 機器はSEIL/X1
    * ACアダプタが無かったのでソフトバンクAirのものを使用
        * HW-120200J0A (EIAJ4プラグ・12V 2A)
        * メルカリにいっぱい転がってる
* 回線はIIJmioひかり+IPoEオプション
    * transixがつかえる
* ひかり電話なし
    * DHCPv6 PrefixDelegation無しでRouterAdvertisementのみ
* LAN側はIPv4のみ
    * ブリッジすれば行けるらしいが、何となく怖いのでやってない

完成したconfigは[ひかり電話無し環境でSEIL/X1のIPv6 IPoEとtransixを使うconfig](https://gist.github.com/maeda577/e65fd769edca3bcc721eecdac3293937)


ひかり電話ありの場合は公式ブログ見た方が早い。
* [SEIL で NGN IPv6 ネイティブ (IPoE) 接続を試す](https://www.seil.jp/blog/10.html)
* [SEIL/x86 で DS-Lite](https://www.seil.jp/blog/ds-lite.html)

最初の諸々
-------------------------------
1. リセットスイッチ押しながら電源投入し初期化
1. WebGUIでファームウェアアップデート
1. telnetからadminでログイン
    * コンソールでつなぎたかったけどCiscoケーブルじゃ反応しなかった
    * [SEIL/X1、シリアルコンソールケーブル自作 - ＠SRCHACK.ORG（えす・あーる・しー・はっく）](https://www.srchack.org/article.php?story=2018043012521397)

``` shell
# 何はともあれパスワード
password admin
password user
# ホスト名を適当に
hostname seilx1
# ログイン後のタイムアウトを伸ばす
environment login-timer 43200
# 日時設定(後でSNTP設定)
date 202006011200.00
```

IPv4関係
-------------------------------

``` shell
# フィルタ定義(怪しいものブロック)
filter add winrpc_block interface pppoe0 direction in/out action block protocol tcp dstport 135 state disable logging on enable
filter add netbios_block interface pppoe0 direction in/out action block protocol tcp dstport 137-139 state disable logging on enable
filter add smb_block interface pppoe0 direction in/out action block protocol tcp dstport 445 state disable logging on enable
filter add local_192_block interface pppoe0 direction in action block src 192.168.0.0/16 state disable logging on enable
filter add local_172_block interface pppoe0 direction in action block src 172.16.0.0/12 state disable logging on enable
filter add local_10_block interface pppoe0 direction in action block src 10.0.0.0/8 state disable logging on enable

# フィルタ定義(LAN->WANは動的フィルタで全開、WAN->LANは全閉じ)
filter add lan_pass interface pppoe0 direction out action pass state enable logging off enable
filter add wan_block interface pppoe0 direction in action block state disable logging on enable
filter add wan_block2 interface lan1 direction in action block state disable logging on enable

# PPPoE設定
ppp delete all
ppp add web-config keepalive 30 ipcp enable ipcp-address on ipcp-dns on ipv6cp disable authentication-method auto identifier *********** passphrase *********** tcp-mss auto
interface pppoe0 ppp-configuration web-config
show status ppp pppoe0
```
これでとりあえずPPPoEが繋がる。

IPv6関係
-------------------------------
全体を通して、上手くいかないときは少し待ってみる。放っておくとつながったりする。

``` shell
# フィルタ定義(DHCPv6とICMPv6の必要そうなやつを開ける)
filter6 add dhcpv6_pass interface lan1 direction in action pass protocol udp dst self dstport 546 state disable logging off enable
filter6 add icmpv6_ra_pass interface lan1 direction in action pass protocol ipv6-icmp icmp-type 134 state disable logging off enable
filter6 add icmpv6_ns_pass interface lan1 direction in action pass protocol ipv6-icmp icmp-type 135 state disable logging off enable

# フィルタ定義(LAN->WANは動的フィルタで全開、WAN->LANは全閉じ)
filter6 add lan_pass interface lan1 direction out action pass state enable logging off enable
filter6 add wan_block interface lan1 direction in action block state disable logging on enable
filter6 add wan_block2 interface pppoe0 direction in action block state disable logging on enable

# lan1のprefixはRAからつける(transix環境なら2409とかが降ってくる)
interface lan1 add router-advertisement
show status interface lan1

# デフォルトゲートウェイもRAから
route6 add default router-advertisement interface lan1
show status route6

# このあたりでpingぐらいは通るはずなのでGooglePublicDNSに投げてみる
ping6 2001:4860:4860::8888

# DHCPv6で色々取る(DNSサーバとNTPサーバが降ってくる)
dhcp6 client interface lan1
dhcp6 client enable
show status dhcp6

# ルーター自身の参照DNSを設定
resolver address add dhcp6
resolver enable

# フォワードするDNSを設定
dns forwarder add dhcp6

# NTPサーバを設定
ntp mode client
ntp server add dhcp6
ntp enable
show status ntp
```

transixの設定
-------------------------------
[SEIL/x86 で DS-Lite](https://www.seil.jp/blog/ds-lite.html) を元に設定していく。
``` shell
# フィルタでIP-in-IP通信を通す
filter6 add dslite_pass interface lan1 direction in/out action pass protocol 4 state disable logging off above wan_block

# トンネル作成
interface tunnel0 tunnel dslite gw.transix.jp
show status interface tunnel0

# トンネルにフィルタ設定(IPv4の内->外は全開で他は閉じる)
filter add dslite_lan_pass interface tunnel0 direction out action pass state enable logging off enable
filter add dslite_wan_block interface tunnel0 direction in action block state disable logging on enable
filter6 add dslite_block interface tunnel0 direction in/out action block logging on

# 元記事に沿って各パラメータ設定
interface tunnel0 mtu 1500
interface tunnel0 unnumbered
option ipv6 avoid-path-mtu-discovery off

# デフォルトゲートウェイ変更
route delete default
route add default tunnel0
show status route
```

pingでテストしてみる
* SEIL側で tcpdump interface tunnel0 expression icmp
* 適当なPC側で ping -4 -t 8.8.8.8

なんか流れていればOK

LAN側へのIPv6
-------------------------------
LAN0とLAN1をブリッジすれば行けるらしいが試していない。ブリッジ周りの挙動は [TECHNICAL MANUAL - ブリッジ（ブリッジモード）](https://www.seil.jp/doc/index.html#fn/bridge/bridge.html)

さいごに
-------------------------------
保存を忘れると停電したとき悲しい。
``` shell
save-to flashrom
```
